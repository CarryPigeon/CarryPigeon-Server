<?xml version="1.0" encoding="UTF-8"?>
<flow>
    <!-- 发送频道消息 -->
    <chain name="/core/channel/message/create">
        THEN(
        /** 判断是否登录并将 SessionId 映射为 UserInfo_Id **/
        UserLoginGuard,
        /** 参数重命名 + 成员存在校验 **/
        MemberGuard,
        /** 校验用户是否被禁言 **/
        CPChannelBanChecker,
        /** 查询频道信息，供后续通知使用 **/
        CPChannelSelector.bind("key","id"),
        /** 解析消息体 **/
        CPMessageParse,
        /** 构建消息实体 **/
        CPMessageBuilder,
        /** 持久化消息 **/
        CPMessageSaver,
        /** 收集频道所有成员用于通知 **/
        CPChannelMemberCollector,
        /** 构建通知数据 **/
        CPMessageCreateNotifyBuilder,
        /** 通知频道内所有成员 **/
        CPNotifier.bind("route","/core/message")
        )
    </chain>

    <!-- 删除频道消息 -->
    <chain name="/core/channel/message/delete">
        THEN(
        /** 判断用户是否登录 **/
        UserLoginChecker,
        /** 查询消息信息 **/
        CPMessageSelector,
        /** 删除权限校验 **/
        CPMessageDeletePermissionChecker,
        /** 删除消息 **/
        CPMessageDeleter,
        /** 查询频道信息，供后续通知使用 **/
        CPChannelSelector.bind("key","id"),
        /** 收集频道所有成员用于通知 **/
        CPChannelMemberCollector,
        /** 构建删除消息通知数据 **/
        CPMessageDeleteNotifyBuilder,
        /** 通知频道内所有成员 **/
        CPNotifier.bind("route","/core/message")
        )
    </chain>

    <!-- 拉取频道消息列表 -->
    <chain name="/core/channel/message/list">
        THEN(
        /** 判断是否登录并将 SessionId 映射为 UserInfo_Id **/
        UserLoginGuard,
        /** 参数重命名 + 成员存在校验 **/
        MemberGuard,
        /** 拉取消息列表 **/
        CPMessageLister
        )
    </chain>

    <!-- 获取单条频道消息 -->
    <chain name="/core/channel/message/get">
        RenameScript = '{"SessionId":"ChannelMemberInfo_Uid","ChannelInfo_Id":"ChannelMemberInfo_Cid"}';
        THEN(
        /** 判断用户是否登录 **/
        UserLoginChecker,
        /** 查询消息信息 **/
        CPMessageSelector,
        /** 将 SessionId、频道 id 映射为成员选择所需的参数，用于校验是否在频道中 **/
        RenameArg.data(RenameScript),
        /** 校验用户是否在频道中 **/
        CPChannelMemberSelector.bind("key","CidWithUid")
        )
    </chain>

    <!-- 获取未读消息数量 -->
    <chain name="/core/channel/message/unread/get">
        THEN(
        /** 判断是否登录并将 SessionId 映射为 UserInfo_Id **/
        UserLoginGuard,
        /** 参数重命名 + 成员存在校验 **/
        MemberGuard,
        /** 计算未读消息数量 **/
        CPMessageUnreadCounter
        )
    </chain>

    <!-- 更新频道消息已读状态 -->
    <chain name="/core/channel/message/read/state/update">
        THEN(
        /** 判断是否登录并将 SessionId 映射为 UserInfo_Id **/
        UserLoginGuard,
        /** 参数重命名 + 成员存在校验（基于读状态 cid） **/
        ReadGuard,
        /** 更新已读状态 **/
        CPChannelReadStateUpserter,
        /** 收集当前用户自身会话对应的 uid **/
        CPUserSelfCollector,
        /** 构建已读状态通知数据 **/
        CPChannelReadStateNotifyBuilder,
        /** 通知该用户的所有在线会话 **/
        CPNotifier.bind("route","/core/channel/message/read/state")
        )
    </chain>

    <!-- 获取频道消息已读状态 -->
    <chain name="/core/channel/message/read/state/get">
        THEN(
        /** 判断是否登录并将 SessionId 映射为 UserInfo_Id **/
        UserLoginGuard,
        /** 参数重命名 + 成员存在校验（基于读状态 cid） **/
        ReadGuard,
        /** 查询已读状态（若不存在则返回默认值） **/
        CPChannelReadStateSelector
        )
    </chain>
</flow>
