<?xml version="1.0" encoding="UTF-8"?>
<flow>
    <!--用户注册请求-->
    <chain name="/core/user/register">
        THEN(
            /**校验邮箱是否合法**/
            EmailValidChecker,
            /**校验邮箱是否已经注册**/
            EmailExistsChecker,
            /**校验邮箱验证码**/
            EmailCodeChecker,
            /**创建用户**/
            CPUserBuilder,
            /**保存用户**/
            CPUserSaver,
            /**创建用户token**/
            CPUserTokenCreator
        );
    </chain>
    <!--获取用户信息请求-->
    <chain name="/core/user/profile/get">
        THEN(
            /**判断是否登录**/
            UserLoginChecker,
            /**通过id获取用户信息**/
            CPUserSelector.bind("key","id")
        );
    </chain>
    <!--修改用户信息-->
    <chain name="/core/user/profile/update">
        THEN(
            /** 判断是否登录并将 SessionId 映射为 UserInfo_Id **/
            UserLoginGuard,
            /**查询用户信息**/
            CPUserSelector.bind("key","id"),
            /**修改用户信息**/
            CPUserUpdater,
            /**持久化用户信息**/
            CPUserSaver,
            /**构建通知用户**/
            CPUserRelatedCollector,
            /**发送通知**/
            CPNotifier.bind("route","/core/user/profile/get")
        );
    </chain>
    <!--修改用户邮箱-->
    <chain name="/core/user/profile/update/email">
        THEN(
            /** 判断是否登录并将 SessionId 映射为 UserInfo_Id **/
            UserLoginGuard,
            /**判断邮箱是否格式正确**/
            EmailValidChecker,
            /**判断验证码是否正确**/
            EmailCodeChecker,
            /**获取用户**/
            CPUserSelector.bind("key","id"),
            /**更新用户数据**/
            CPUserUpdater,
            /**持久化用户信息**/
            CPUserSaver
        )
    </chain>
    <!--用户登录-->
    <chain name="/core/user/login/email">
        THEN(
            /**邮箱校验**/
            EmailValidChecker,
            /**邮箱验证码校验**/
            EmailCodeChecker,
            /**用户查询**/
            CPUserSelector.bind("key","email"),
            /**用户token创建**/
            CPUserTokenCreator
        )
    </chain>
    <!--用户token登录-->
    <chain name="/core/user/login/token">
        THEN(
            /**获取token**/
            CPUserTokenSelector.bind("key","token"),
            /**用户token校验**/
            CPUserTokenUidGetter,
            /**用户获取**/
            CPUserSelector.bind("key","id"),
            /**用户token更新**/
            CPUserTokenRefresh,
            /**数据持久化**/
            CPUserTokenSaver,
            /**将用户注册进上下文**/
            CPSessionRegister
        )
    </chain>
    <!--用户登出（删除token）-->
    <chain name="/core/user/login/token/logout">
        THEN(
            /**判断用户是否登录**/
            UserLoginChecker,
            /**获取token**/
            CPUserTokenSelector.bind("key","token"),
            /**用户token删除**/
            CPUserTokenDeleter
        )
    </chain>
</flow>
