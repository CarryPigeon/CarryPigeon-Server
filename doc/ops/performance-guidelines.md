# 性能优化指南

> 本文聚焦当前对外协议（HTTP `/api` + WebSocket `/api/ws`）的性能实践。

## 1. API 层优化

- 列表接口统一走分页/游标（见 `doc/api/14-分页与游标规范.md`）
- 严控返回字段，避免一次性返回大对象
- 对高频读取接口（如用户简档、频道元信息）使用缓存
- 限制单请求 `page_size`，防止放大查询

## 2. WebSocket 事件优化

- 事件只推必要字段，详情走 HTTP 补拉
- 客户端持久化 `event_id`，重连优先 `resume`
- `resume.failed` 后走增量补拉，避免全量刷新风暴
- 推送发送失败需快速剔除失效会话，减少重试成本

## 3. LiteFlow 链路优化

- 链路前置校验（鉴权/权限/参数），尽早失败
- 节点职责单一，避免重复查询
- 高耗时节点（外部调用）增加超时与降级
- Result 节点只负责组装响应，不做重业务计算

## 4. 存储与缓存优化

- DB 索引按访问路径建设（`uid/cid/mid/send_time`）
- 热点读取优先 Redis 缓存，设置合理 TTL
- 写路径保持幂等，避免重试导致重复写入
- 大字段（文件元信息、插件清单）按需拆分存储

## 5. 压测建议

- 核心场景：登录、拉消息、发消息、读状态更新、WS 事件推送
- 关注指标：吞吐、P95/P99、错误率、依赖耗时、GC 停顿
- 压测中验证限流策略与错误模型稳定性（`429 rate_limited`）

## 6. 常见性能反模式

- 在链路节点里做阻塞式远程调用且无超时
- 推送 payload 过大，挤占 WS 带宽
- 缺少游标分页导致深分页慢查询
- 仅依赖 WS 不做补拉，断线后状态难恢复
