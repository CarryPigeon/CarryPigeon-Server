# CarryPigeon（客户端 + 插件生态）产品需求文档（PRD）

> 说明：本文件归档在 `doc/` 目录下，作为产品与接口约束的上游文档。

版本：v1.1  
日期：2026-01-31  
面向：产品 / 客户端 / 服务端 / 插件开发者

变更记录：
- v1.1（2026-01-31）：补齐范围/风险/埋点等缺失章节，修正编号与验收用例序号。
- v1.0（2026-01-31）：初版。

---

## 0. 背景与概述

CarryPigeon 是一个面向“自建服务器”的聊天客户端产品，核心包提供稳定的**频道群聊基座**；针对垂直场景（例如 MC 服务器绑定、诗词排版渲染、数学公式渲染等）通过**客户端插件 + 服务端插件**协作实现。产品优先保证架构可扩展、契约稳定、插件隔离与安全边界清晰。

### 0.1 文档范围与读者
- 本 PRD 定义：MVP（V0/V1/V2）要做什么、不要做什么、以及验收口径；同时给出插件生态所需的端到端契约边界。
- 本 PRD 不包含：具体 UI 视觉稿、完整接口细节与字段枚举（详见 `doc/api/*`）、具体实现设计（详见模块与插件文档）。

约束：
- 客户端：PC 端 + 移动端；不做 Web 端产品（但移动端采用 Web/Vue 技术路线实现跨平台插件 UI）。
- 会话模型：仅频道群聊；私聊等能力不进核心包（可由插件生态扩展，但不作为 MVP 目标）。
- 权限模型（核心）：owner / admin / member + 禁言 + 入群申请。

---

## 1. 目标、非目标与成功标准

### 1.1 产品目标（MVP）
- 打通核心链路：连接服务器 → 登录/注册 → 进入频道 → 收发消息 → 回复 → 删除（硬删除）→ 已读/未读基础能力。
- 插件系统闭环：支持**自定义消息 domain + 自定义渲染 + 自定义输入（composer）**，并可与服务端插件协作完成校验/落库/推送。
- 插件按服务器隔离：同一客户端连接不同服务器可使用不同插件集合/版本，互不影响。

### 1.2 非目标（MVP 不做）
- 私聊/好友/会话列表体系。
- 复杂 RBAC（更细粒度角色/权限交由插件或后续版本）。
- 强多端同步（允许多端，但不强保证草稿/已读/状态严格一致）。
- 插件签名与信任体系（规划项）。

### 1.3 成功标准（验收口径）
- 核心包无需修改，即可通过插件实现以下至少一种场景能力闭环：
  - 数学公式消息：自定义 composer 输入 + 渲染 + 服务端校验/落库/推送。
- “删除=消失”：任何客户端在删除后通过历史拉取也不可再看到该消息。
- 插件 required 机制可用：服务端声明 required 插件后，客户端在未安装时**阻止登录**并引导安装。

### 1.4 产品指标（建议作为阶段性目标）
说明：指标用于验证“可用性/稳定性/生态闭环”，不作为上线硬门槛时可标记为观察项。
- 激活：新用户在首次连接后完成登录并进入任意频道的比例。
- 核心留存：7 日内至少发送 1 条消息的用户比例。
- 稳定性：崩溃率（按会话/按启动）、关键链路失败率（连接/登录/拉取/发送）。
- 生态：安装 required 插件后成功登录比例；插件安装/启用失败率；未知 domain 的降级可读率（preview 命中率）。

---

## 2. 用户与场景

### 2.1 目标用户
1) 服务器管理员/群主：需要自建、可控、可扩展（插件化）来满足垂直需求。  
2) 普通群成员：需要稳定可用的频道聊天体验。  
3) 插件开发者：需要清晰的契约、扩展点、权限模型与调试路径。

### 2.2 典型垂直场景（通过插件实现）
- MC 服务器群：账号与 MC 账号绑定、身份展示、指令/事件消息类型。
- 诗词讨论群：特定文本结构化与排版渲染（章句、注释、引用）。
- 数学群：公式（LaTeX）渲染与结构化消息输入。

### 2.3 核心用户旅程（主流程）
1) 添加服务器（socket + TLS 证书信任策略）  
2) 建立连接并完成握手  
3) 获取服务器信息与插件目录；若存在 required 插件则进入安装向导  
4) 注册/登录并绑定当前连接会话  
5) 拉取频道列表 → 进入频道  
6) 拉取历史消息 → 实时收消息推送  
7) 发送消息（文本/插件 domain）  
8) 回复消息（`reply_to_mid`）  
9) 删除消息（硬删除）  
10) 已读上报/未读计数显示

---

## 3. 术语与范围定义

### 3.1 关键术语
- `server_socket`：服务器地址标识（客户端用于区分服务器隔离域）。
- `server_id`：服务端返回的固定 UUID（客户端用于插件安装与本地缓存隔离）。
- `cid`：频道 id。
- `mid`：消息 id。
- `uid`：用户 id。
- `domain`：消息域/类型标识，如 `Core:Text`、`Math:Formula`。
- `domain_version`：domain 契约版本（SemVer）。
- 插件（Plugin）：以服务器为单位安装/启用的扩展包，提供 domain 的 composer/renderer 等能力。

### 3.2 服务器级隔离（强约束）
- 插件安装状态、版本、缓存、登录态均以 `server_id` 为命名空间隔离。
- 同一服务器下的不同频道共享同一套插件（频道不声明/不约束插件）。

补充（P0，确定）：
- 插件与缓存的本地隔离键使用 `server_id`（固定 UUID）；`server_socket` 仅用于连接与展示。
- 插件运行期的存储命名空间也以 `server_id` 隔离（避免 socket 变更导致污染）。
- “插件集合归属”的产品语义以“当前连接的服务器”理解即可；实现侧以 `server_id` 落地隔离与存储。

---

## 4. 功能需求（按优先级）

标记说明：P0=必须，P1=重要但可延后，P2=规划。

### 4.1 服务器与连接（P0）
- P0-S1 服务器管理：新增/编辑/删除服务器条目（socket、备注名、TLS 信任策略、通知模式）。
- P0-S2 连接与握手：连接服务器、握手成功后进入可用态；断线可重连。
- P0-S3 服务器信息：拉取服务器基础信息（名称、简介、头像、时间、`server_id`）。

### 4.1.1 server_id 获取与兼容性（P0）
- 客户端必须在展示插件中心/执行插件安装前，先从“服务器信息接口”获取 `server_id`。
- 若服务端未提供 `server_id`：
  - 客户端应禁用插件安装入口并提示“服务器版本不兼容（缺少 server_id）”；
  - 核心聊天功能仍可用（不影响登录/频道/消息的核心链路）。

### 4.2 登录与账号（P0）
- P0-A1 邮箱验证码：发送验证码。
- P0-A2 注册：邮箱+验证码注册获得 token。
- P0-A3 登录：邮箱+验证码登录获得 token。
- P0-A4 token 登录绑定会话：使当前连接进入“已登录”状态。
- P0-A5 退出登录：使 token 失效并回到未登录状态。

### 4.3 频道（P0）
- P0-C1 频道列表：拉取当前用户加入的频道列表。
- P0-C2 频道创建/删除/资料：owner 可创建/删除频道并更新资料（name/brief/avatar）。
- P0-C3 入群申请：非成员可申请加入；admin 可审批通过/拒绝。
- P0-C4 成员管理：成员列表；admin 踢人；owner 设/撤 admin。
- P0-C5 禁言：admin 可对成员设置/解除禁言；被禁言者不可发消息。

### 4.4 消息（P0）
- P0-M1 拉取历史消息：分页/增量拉取。
- P0-M2 发送消息：支持 `Core:Text`，并支持插件 domain 消息发送。
- P0-M3 实时收消息：收到推送后更新 UI、未读、预览。
- P0-M4 回复：发送时支持 `reply_to_mid`；渲染上展示引用关系（不泄露已删内容）。
- P0-M5 删除（硬删除）：删除后对所有人不可见；历史拉取/get 不返回；UI 不展示“已删除占位”。

### 4.5 已读/未读（P0）
- P0-R1 已读上报：在合适时机更新 `last_read_time`（只前进不后退）。
- P0-R2 未读计数：可按频道获取未读数量并展示。

### 4.6 插件系统（P0，核心卖点）
- P0-P1 插件目录发现（server catalog）：从服务器拉取可用插件列表（含 required 插件）。
- P0-P2 required 插件 Gate：若 required 未满足，则**阻止登录**，仅允许安装插件与查看服务器信息。
- P0-P3 插件安装来源：
  - 服务器提供下载 URL（可指向服务器或仓库）。
  - 支持添加仓库源（Repo Catalog）。
- P0-P4 插件生命周期：安装/启用/禁用/卸载；按服务器隔离存储。
- P0-P4.1 插件更新：支持“检查更新 → 用户确认后更新”，并在 enable 成功后切换 current 版本；失败需保留旧版本可回滚。
- P0-P5 消息扩展：
  - 插件可提供 domain 的 renderer（渲染组件）
  - 插件可提供 domain 的 composer（输入组件，PC+移动同一套 Vue 技术栈）
  - 插件可附带 domain contract（schema + 约束）
- P0-P6 权限（粗粒度）：插件 manifest 声明权限集合；宿主按权限注入 Host API 能力。
  - 约定：`storage` 不需要声明，宿主默认提供按 `server_id` 隔离的存储能力。

### 4.7 文件（P1）
- P1-F1 附件上传/下载：token 申请 + HTTP 上传下载。
- P1-F2 文件类消息：由插件定义 domain 与渲染（如图片/音频/文档预览）。

---

## 5. 插件与消息扩展设计（端到端契约）

### 5.1 插件包格式（确定）
- 格式：ESM（`index.js`）+ 静态资源（可含 CSS、图片、字体等）。
- UI：Vue 组件（跨 PC/移动）。
- 加载方式：下载后安装到本地，通过应用内静态资源协议加载（例如 `app://plugins/...`），不依赖在线远端加载。
- 生态约定：
  - 插件包安装后必须可直接执行：宿主不对插件做二次编译/转译/模板编译/样式预处理。
  - 插件包不包含编译前源文件（例如 `.vue`、`.ts`、`*.scss`）；插件必须发布构建产物（ESM + 静态资源）。
  - 插件 CSS 允许影响宿主全局样式。

### 5.2 插件作用域与共享（确定）
- 插件以 `server_socket` 为作用域：
  - 同一服务器所有频道共享同一插件集合/版本。
  - 不同服务器可安装不同版本/不同插件集合，互不影响。
- 频道不对插件作任何约束（无 channel required）。

补充（实现口径）：
- 插件的本地隔离与安装目录以 `server_id` 为准；插件集合的“归属服务器”语义仍然是“当前连接的服务器”。

### 5.3 Domain Contract（确定义）
每个 domain 必须有契约（Contract），至少包含：
- `domain: string`
- `domain_version: string`（SemVer）
- `payload_schema: object`（JSON Schema 或等价描述）
- `constraints`（大小/长度/深度/字段白名单等）

服务端对非 `Core:*` domain 必须执行：
- schema 校验（拒绝未知字段/非法结构）
- 尺寸限制（最大 payload bytes、最大嵌套深度）
- 频率限制（按 uid/cid）

### 5.4 插件 Manifest（建议字段）
- `plugin_id`（全局唯一）
- `name`
- `version`
- `min_host_version`
- `permissions[]`（粗粒度：`network/clipboard/notifications` 等；`storage` 默认提供无需声明）
- `provides_domains[]`：`{ domain, domain_version }`
- `contracts[]`：内置 schema 或 `schema_url + sha256`
- `entry`：`index.js`

### 5.5 Host API（宿主注入，最小集合）
宿主对插件暴露的 API 必须“能力白名单 + 权限控制”，最小集合建议：
- `getContext()`：只读上下文（当前 server_id/server_socket、uid、语言、当前 cid 等）。
- `sendMessage({ cid, domain, domain_version, data, reply_to_mid? })`
- `openUrl(url)`（可选，受权限控制）
- `storage.get/set`（P0 默认提供；必须按 server_id 隔离命名空间）

补充（P0，确定）：
- 插件即使声明 `network` 权限，宿主也必须将网络访问限制在“当前 `server_socket` 对应地址（及其明确的下载端点）”，禁止访问任意公网。

### 5.6 required 插件 Gate（确定）
当服务器声明 required 插件且客户端未满足时：
- 允许：连接/握手、获取服务器信息、获取插件目录、下载/安装/启用插件。
- 禁止：所有登录相关路由（register/login/token-login）。

错误响应（P0，确定）：
- 服务端需返回可被客户端稳定识别的错误：`reason="required_plugin_missing"`，并包含 `missing_plugins[]`。
- 推荐：使用独立错误码（例如 `code=320`），避免与通用鉴权错误混淆。

---

## 6. 数据与协议（PRD 级别，字段口径）

说明：协议底层可沿用现有 TCP/HTTP 体系；此处定义 PRD 必须满足的“字段语义与事件”。

### 6.1 统一消息模型（所有 domain 共用）
频道消息实体（服务端落库与下发）：
- `mid: number`
- `cid: number`
- `uid: number`
- `send_time: number`（ms）
- `domain: string`
- `domain_version: string`
- `data: object`
- `reply_to_mid?: number`

### 6.2 删除（硬删除，确定）
- 删除后：list/get 不得返回该消息。
- 推送 delete 事件后：客户端从列表与本地缓存移除该 `mid`，不显示占位。
- 回复引用已删除消息：不得在任何渲染中泄露被删内容（引用可降级为空）。

### 6.3 推送事件（最小必要信息）
统一推送 channel：`/api/ws`

#### 6.3.1 新消息（create）
payload 最小字段：
- `type: "create"`
- `mid, cid, uid, send_time`
- `domain, domain_version`
- `reply_to_mid?`
- `preview?`（服务端生成、长度上限；用于未装插件时的降级展示）

#### 6.3.2 删除（delete）
payload 最小字段：
- `type: "delete"`
- `mid, cid`
- `delete_time`

### 6.4 插件目录与契约发现
PRD 需要以下能力（路由命名可调整，以实现为准）：
- 插件目录：返回 `plugins[]`，其中包含 `required: boolean` 与下载信息。
- domain 目录：返回 server 支持的 `domains[]`（含 accepts/version-range 与 contract 指针）。

---

## 7. 交互与体验要求（关键点）

### 7.1 required 插件安装向导（P0）
- 触发：连接服务器后发现 required 未满足。
- 行为：进入安装页，引导下载/安装/启用；显示来源（server/repo）、版本与权限。
- 结果：required 满足后，返回登录页；未满足则不得继续登录。

补充规范：
- 插件中心/安装向导实现应以 `doc/api/11-HTTP端点清单.md` 与 `doc/api/13-错误模型与Reason枚举.md` 为准。

### 7.2 未安装插件的消息降级展示（P0）
- 不阻塞进入频道/浏览聊天。
- 对未知 domain：
  - 优先显示 `preview`；无 preview 则显示“此消息需要插件 X”提示（不展示原始 data 全量）。
  - 提供“一键安装插件”（跳转到插件中心）入口。

### 7.3 关键异常与降级（P0）
- 连接失败：明确区分“网络不可达/握手失败/版本不兼容/证书或公钥校验失败（若启用）”，并提供重试与编辑服务器入口。
- 登录失败：明确区分“验证码错误/账号不存在/鉴权失效/required 插件缺失”等可操作原因；required 缺失必须跳转到安装向导。
- 拉取失败（频道/历史）：允许用户手动重试；失败时不阻塞进入应用框架与查看本地缓存（若有）。
- 推送断连：展示弱提示（如状态条），并在恢复后自动拉取增量以补齐。

---

## 8. 非功能需求与指标（P0）

### 8.1 安全
- 插件数据隔离：不同 `server_id` 之间的插件数据与缓存完全隔离。
- 服务端校验强制：所有非 `Core:*` domain 必须校验 schema/大小/频率。
- 插件网络边界：插件网络访问（若开放）仅限当前 `server_socket`，禁止任意公网访问。

### 8.2 可靠性
- 插件加载失败可降级：不影响核心聊天可用性（但 required 插件失败则无法登录该服务器）。
- 断线重连：可恢复到“可登录/可拉取”的状态。

### 8.3 性能（建议作为验收阈值，按实现调整）
- 冷启动到可操作：PC ≤ 3s（目标值）。
- 频道消息列表支持大列表（建议虚拟列表/分页），不出现长时间卡死。
- 推送 payload 有明确大小上限与频率控制。

### 8.4 隐私与数据治理（P0 约束）
- 客户端本地数据：以 `server_id` 为隔离域，包含登录态、插件、缓存、日志等；切换服务器不得互相可见。
- 数据留存（建议默认策略，可按服务器配置调整）：本地消息缓存可按“时间/容量上限”淘汰；提供一键清理当前服务器数据入口。
- 诊断信息：若采集崩溃/日志，必须支持用户关闭与清理；默认不上传敏感 payload（尤其是非 `Core:*` 的 `data` 全量）。

### 8.5 插件运行时（P0）
- 宿主不进行 `.vue`/TS 运行时编译；插件必须发布构建产物。

---

## 9. 里程碑与版本拆分

### V0 基座可用（无插件也能聊）
- 登录/注册、频道、收发 `Core:Text`、回复、硬删除、已读/未读、最小推送。

### V1 插件系统闭环（服务器级共享 + required Gate）
- server catalog、repo catalog、安装/启用/禁用/卸载、检查更新→用户确认更新、required 阻止登录、权限声明与宿主 API 注入。

### V2 自定义 domain 闭环（客户端+服务端插件协作）
- domain contract、服务端校验与落库、客户端 composer+renderer、未知 domain 降级展示、preview 生成策略。

### V3 生态完善（规划）
- 插件更新/回滚策略、签名与信任体系、权限审计与日志、搜索/通知等体验增强。

---

## 10. 验收用例（P0 必测）

### 10.1 核心聊天
1) 注册/登录成功后可进入频道列表并进入某频道。  
2) 发送 `Core:Text`，所有在线成员收到 create 推送并可拉取到消息。  
3) 回复消息：发送时携带 `reply_to_mid`，历史拉取仍能看到引用关系。  
4) 删除消息：删除后，所有端消息列表中该消息直接消失；历史拉取/get 均不可再得到该消息。  
5) 已读/未读：进入频道更新 `last_read_time`；未读计数随之变化。  

### 10.2 插件 required Gate
6) 服务端声明 required 插件 A：客户端未安装时可以连接并看到安装向导，但无法登录。  
7) 安装并启用 required 插件 A 后：登录接口放行，进入聊天主界面。  
8) 插件声明 `network` 权限：只能访问当前服务器地址；访问其他域名/公网地址被宿主拒绝。  
9) 插件无需声明 `storage` 权限即可读写“当前 server_id 命名空间”的存储；切换服务器后读不到另一服务器的数据。  
10) 插件更新：检查更新后用户确认升级；若新版本 enable 失败，客户端自动回滚到旧版本且插件仍可用。  
11) required 插件启用失败：客户端提示错误且持续阻止登录；用户修复（重试/回滚/重装）后登录放行。  

### 10.3 自定义 domain（插件协作）
12) 安装插件（客户端+服务端）后可发送 `Math:Formula`：服务端校验通过并落库。  
13) 未安装插件的客户端仍可进入频道并看到该消息的 preview（不展示原始 data 全量）。  
14) 删除自定义 domain 消息后，所有端不可再通过任何方式看到其内容。  
15) 插件发布构建产物：入口 `entry` 指向 `*.js`（如 `dist/index.js`），插件包不包含 `.vue/.ts` 源文件且仍可正常渲染与发送消息。  

---

## 11. 埋点与可观测性（建议，便于验收与排障）
说明：本节用于指导实现最小可观测性闭环，避免“看起来能用但无法定位问题”。

### 11.1 最小埋点事件（建议）
- 连接链路：server_add/edit/delete、connect_attempt/success/fail（带 reason）、handshake_success/fail。
- required Gate：required_detected、required_install_start/success/fail、login_blocked_required_missing。
- 消息链路：history_fetch_start/success/fail、push_connected/disconnected、send_attempt/success/fail、delete_attempt/success/fail。
- 插件链路：plugin_download_start/success/fail、plugin_install_start/success/fail、plugin_enable_start/success/fail、plugin_rollback_triggered。

### 11.2 日志与诊断（P0 约束）
- 本地日志需按 `server_id` 隔离，且支持导出/清理。
- 关键错误必须带可定位的错误码/原因字段（例如 `required_plugin_missing`）。

---

## 12. 依赖、风险与假设（建议）

### 12.1 关键依赖
- 服务端能力：提供稳定的 `server_id`、插件目录与 required 声明、domain contract 发现、推送通道与 delete 事件。
- 插件仓库/分发：下载链接可用性、版本管理与回滚策略（至少要支持“旧版本可回退”）。

### 12.2 主要风险与应对
- 插件安全边界不足：默认最小权限、网络强限制、对未知 domain 降级不泄露 data 全量、服务端强校验。
- required 插件装不上导致无法登录：安装向导状态机清晰、失败原因可见、可重试/回滚/切换源。
- 契约漂移（插件/服务端/客户端版本不一致）：domain_version 与 SemVer 规则、兼容策略与明确的错误码提示。

---

## 13. 开放问题（后续再定）
- 插件签名与信任（P1/P2）：签名格式、仓库可信根、服务端白名单策略。
- 搜索与索引：自定义 domain 的可搜索字段与索引策略。
- 更细粒度权限与审计：插件能力的细分与用户授权交互。
