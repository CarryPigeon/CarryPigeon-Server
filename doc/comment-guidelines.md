# Java 注释规范（强制）

> 目标：统一项目内 **文档级（类型/文件）**、**方法级**、**常量级** 的注释写法，使“对外契约、业务意图、关键约束”可被快速理解与维护。
>
> 适用范围：本仓库所有 Java 代码（含插件），除非目录下有更细粒度的规范文件另行覆盖。

---

## 0. 总原则（必须遵守）

1. **注释写“为什么/约束/契约”，避免写“代码做了什么”**（代码本身已表达 what）。
2. **对外暴露的接口、协议、路由、配置项必须有注释**：调用方需要靠注释理解行为边界。
3. **可维护性优先**：注释必须与实现保持一致；改代码就要同步改注释。
4. **避免噪音**：禁止无意义注释（例如 “设置变量 x”）。
5. **语言选择**：以中文为主，允许夹带必要英文术语（如 AES-GCM、AAD、session_id）。

---

## 1. 文档级注释（类/接口/枚举/Record）——强制

### 1.1 适用对象

- `public` / `protected` 类型（尤其在 `api/` 模块）
- Spring Bean（Controller/Service/Config）
- Netty/LiteFlow 关键链路组件
- 领域模型、DAO 接口、协议对象（CPPacket/CPResponse/CPNotification 等）

### 1.2 必备内容（按需选，但至少包含 1~3 条关键信息）

- **职责**：这个类型负责什么，边界是什么（不做什么）。
- **使用场景**：在哪条链路/路由/模块中被用到。
- **关键约束**：线程安全、幂等性、性能/IO、生命周期、序列化字段约定等。
- **外部契约**：输入/输出、错误码、异常语义、兼容行为（如老字段兼容）。

### 1.3 标准模板

```java
/**
 * <一句话职责说明>。
 *
 * <p>使用场景：<在哪条链路/模块/路由出现>。
 *
 * <p>关键约束：
 * <ul>
 *   <li>线程安全：<是/否>（原因/保证方式）。</li>
 *   <li>幂等性：<是否要求/如何保证>。</li>
 *   <li>性能：<是否可能触发 IO/重计算/大对象拷贝>。</li>
 * </ul>
 *
 * <p>外部契约：<对外字段/协议/兼容性说明>。
 */
```

### 1.4 特殊类型补充要求

- **Controller（Netty/HTTP）**
  - 必须写清：路由（path）、权限前置（是否必须登录）、请求/响应 VO/Result。
- **LiteFlow Node**
  - 必须写清：上下文入参 key、出参 key、失败时写入的 `CPResponse.code` 语义、是否会中断 chain。
- **DAO 接口**
  - 必须写清：返回值语义（null/空数组/Optional 是否使用）、缓存策略要求（如果有）、事务边界（若必须在事务内使用）。

---

## 2. 方法级注释（JavaDoc）——强制

### 2.1 必须写的场景

- `public` / `protected` 方法（尤其在 `api/`）
- 业务关键方法（握手、加解密、AAD 校验、分发、通知、鉴权）
- 任何包含 **非显然业务规则** 的方法（例如时间窗口、序列递增、权限矩阵）

### 2.2 必备要素

- **方法语义**：它保证什么、返回什么、失败会怎样。
- **参数约束**：允许为 null 吗？单位是什么？范围是什么？格式是什么？
- **返回值语义**：null 表示什么？空集合表示什么？是否会修改入参对象？
- **异常/错误码**：抛哪些异常或通过 `CPResponse.code` 表达哪些失败。
- **副作用**：是否写 DB/缓存、是否发通知、是否更新 session 属性。

### 2.3 标准模板

```java
/**
 * <一句话描述该方法做什么，以及为什么需要它>。
 *
 * <p>约束：
 * <ul>
 *   <li><参数/状态约束 1></li>
 *   <li><参数/状态约束 2></li>
 * </ul>
 *
 * <p>副作用：<例如写入 context/session、写 DB、发送通知>。
 *
 * @param <name> <含义 + 约束（是否可空/单位/范围/格式）>
 * @return <返回值语义（含 null/空 的含义）>
 * @throws <ExceptionType> <何时抛出，是否会导致连接关闭/事务回滚>
 */
```

### 2.4 返回 `CPResponse` 的约定

当方法负责构造或决定响应时，必须在注释中明确：

- `code=200/100/300/404/500` 的触发条件（至少列出会出现的 code）
- `data` 字段的结构（可以用文字或引用 Result/VO 类型）

---

## 3. 常量级注释——强制

### 3.1 必须写的场景

- 任何 `public static final` 常量（尤其是对外协议字段名、上下文 key、路由、配置 key）
- 安全相关常量（nonce 长度、AAD 长度、时间窗口）
- “魔法数字”替代常量

### 3.2 必备要素

- **含义**：表示什么业务概念。
- **单位**：ms/sec/bytes/count 等（必须写）。
- **取值范围/默认值**：如窗口大小、最大长度。
- **来源**：协议规范、业务约定、兼容原因（如保留旧字段）。

### 3.3 推荐写法

```java
/** AAD 长度（bytes），协议固定为 20：packageId(4) + sessionId(8) + timestampMillis(8)。 */
public static final int AAD_LENGTH = 20;

/** 包时间戳允许的最大延迟（ms），超过则视为过期包并断开连接。 */
public static final long MAX_PACKET_AGE_MS = 180_000L;
```

> 禁止：`// 20`、`// 超时时间` 这种无法单独理解的注释。

---

## 4. VO / Result / Context Key 的注释要求（项目特化）

### 4.1 VO（实现 `CPControllerVO`）

- 类注释：对应 route、字段含义（snake_case 对外字段）、insertData 写入哪些 key。
- 字段注释：是否必填、单位/范围（例如时间戳毫秒）。

### 4.2 Result（实现 `CPControllerResult`）

- 类注释：从上下文读取哪些 key、返回 `data` 结构。
- `process` 方法注释：缺参时如何处理（例如写 `CPFlowKeys.RESPONSE` 并返回错误）。

### 4.3 Context Keys（`attribute/*Keys`）

- 每个 key 常量必须写注释，格式固定为：`<类型>: <语义>`，例如：
  - `/** CPSession: 当前会话对象 */`
  - `/** Long: 当前登录用户的 id */`

---

## 5. 禁止事项（强制）

- 禁止使用过时/误导注释：与代码行为不一致的注释必须在修改时同步更新。
- 禁止用注释“掩盖坏代码”：复杂逻辑优先重构命名/拆方法，注释只补充意图与约束。
- 禁止把大段业务文档塞进代码：超过 20 行的说明应迁移到 `doc/`，代码里只保留链接与关键摘要。

---

## 6. 落地执行（建议流程）

- 新增/修改对外协议、路由、上下文 key 时：
  1) 先补齐文档级/方法级/常量级注释；
  2) 再更新 `doc/api/*` 或 `doc/audience/client-developer-guide.md` 等对外文档；
  3) 最后补测试（如涉及错误码/兼容字段）。

如需“真正强制”（CI 失败），可以在后续引入 Checkstyle/Spotless 并配置 JavaDoc 规则；本规范文档先作为团队约定的强制标准执行。

## 7. 强制校验（已启用）

- 本项目已在 Maven `validate` 阶段启用 `maven-checkstyle-plugin`，强制校验：
  - `public/protected` 类型的 JavaDoc（文档级）
  - `public/protected` 方法/构造器的 JavaDoc（方法级）
  - `public` 变量（含 `public static final` 常量）的 JavaDoc（常量级）
- 本地运行：`mvn -q validate`（或任何会触发 validate 的构建命令）。
