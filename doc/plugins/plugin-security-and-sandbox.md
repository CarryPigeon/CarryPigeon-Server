# 插件安全与沙箱说明（服务端）

> 本文主要讨论：在引入插件后，如何控制风险，避免插件破坏宿主服务的安全性和稳定性。

---

## 1. 安全边界：插件能做什么 / 不能做什么

### 1.1 推荐能力范围

插件适合做的事情：

- 基于已有数据做 **审计 / 统计 / 监控上报**；
- 扩展 **业务链路** 中的校验、打点、通知行为；
- 替换底层实现（侵入性插件）时，提供更高可用 / 可扩展的基础设施实现；
- 扩展服务端对外接口（新增路由 / 新的 LiteFlow 链）。

### 1.2 不推荐/禁止的行为

插件应避免：

- 访问与业务无关的本地文件 / 操作系统资源；
- 随意创建长期驻留线程、线程池、定时任务；
- 修改全局配置（例如 Logger 配置、连接池配置）；
- 捕获但 **吞掉** 宿主应该感知的严重异常；
- 擅自管理数据库 schema（建表、删表、DDL 变更）。

> 简单规则：  
> 插件应该“挂在”宿主上做增量功能，而不是“接管”整个系统。

---

## 2. 侵入性插件的风险与控制

侵入性插件通过替换实现（例如 DAO）直接接管一部分核心逻辑，因此风险更高。

### 2.1 主要风险

- **数据一致性风险**：新实现的事务边界、隔离级别、重试机制与原实现不一致；
- **性能风险**：新实现延迟更高，导致上层链路超时或积压；
- **兼容性风险**：接口语义变化（例如异常类型、错误码、空值处理方式）；
- **安全风险**：新实现访问了不该访问的资源（内网、文件、系统命令等）。

### 2.2 风险控制建议

1. 接口契约对齐：
   - 严格遵守 `api` 模块中接口的语义，不引入隐式行为；
   - 对空返回、异常抛出、边界条件的处理与默认实现保持一致；
   - 日志格式尽量保持兼容，便于统一检索。

2. 使用条件装配 + 配置开关：
   - 通过 `@ConditionalOnProperty` 控制侵入性插件是否启用；
   - 例如 `cp.read-state.dao.mode=distributed`；
   - 便于在出现问题时快速切回默认实现。

3. 灰度与回滚：
   - 优先在测试环境验证，再在小流量实例上灰度；
   - 预先准备好回滚方案（配置 / 镜像 / jar），确保一分钟内能切回。

4. 限制外部依赖：
   - 侵入性插件若依赖外部系统（新的存储 / 服务），需有隔离策略：
     - 网络访问控制（安全组 / 防火墙）；
     - 超时和重试配置；
     - 失败时的降级逻辑。

---

## 3. 拓展性插件的风险与控制

拓展性插件主要以 LiteFlow 节点 + Service 形式存在，相对安全，但仍需注意：

### 3.1 常见风险

- 单个节点执行时间过长，拖慢整条链路；
- 节点抛出未捕获异常，导致整条链路提前失败；
- 节点访问外部系统频率过高，引入新瓶颈或触发限流；
- 节点写入上下文的数据污染了后续节点使用的 key。

### 3.2 风险控制建议

1. 设计为“旁路”而非“关键路径”：
   - 对于审计 / 统计类功能，出错时应尽量不影响主业务：
     - 可以只打日志，不抛 `CPReturnException`；
     - 或在失败时快速返回，避免重试风暴。

2. 控制耗时和调用外部系统：
   - 避免在 LiteFlow 节点中直接做重型 IO（远程 HTTP / 大量 DB 操作）；
   - 如有必要，考虑：
     - 将数据写入队列，由后端消费者异步处理；
     - 或增加简单的限流 / 采样逻辑。

3. 使用统一的错误处理方式：
   - 参数错误使用 `argsError(context)`；
   - 业务错误使用 `businessError(context, message)`；
   - 对于“附加功能”节点，优先使用内部 try-catch + 日志，不要随意抛异常中断链路。

4. 避免污染上下文：
   - 插件节点写入新数据时，最好使用 **独立的 key** 或明确约定的 key；
   - 不要覆盖宿主节点依赖的已有 key（除非经过明确设计）。

---

## 4. 日志与敏感信息

插件日志需要遵守项目统一规范：

- 日志统一使用英文；
- 必要字段：uid / cid / route / id / 时间等；
- 对敏感信息（token、密码、密钥等）不做明文输出；
- 错误日志中避免打印整个对象（尤其是包含敏感字段的 BO）。

建议：

- 对外部接口调用失败、权限校验失败、数据不一致等情况，打清晰的 warning / error；
- 不在 debug 日志中包含隐私数据（邮箱、手机号等）。

---

## 5. 与沙箱 / 多环境策略配合

虽然当前项目本身没有内置“运行时沙箱”，但可以通过多环境和配置策略实现类似效果：

1. 开发环境：
   - 插件自由度最高，可以访问更多资源；
   - 但不建议将这些配置迁移到测试 / 生产。

2. 测试 / 预发布环境：
   - 启用与生产尽量接近的安全策略和资源限制；
   - 插件默认开启更多监控和日志；
   - 作为安全检查和性能验证的主战场。

3. 生产环境：
   - 仅启用经过充分验证的插件；
   - 使用保守的超时和重试配置；
   - 对侵入性插件尤其慎重，优先考虑拓展性方案。

---

## 6. 插件开发者自查清单

在提交或上线一个插件前，可以按下面的清单自查：

1. 我是否只依赖了 `api` 和明确暴露的扩展点？
2. 插件中的节点 / Service 是否有明确的性能边界（最大耗时、外部调用次数）？
3. 所有可能抛出的异常是否都被合适地处理或记录？
4. 日志中是否包含敏感信息？是否足够帮助排查问题？
5. 是否有配置开关可以快速禁用或切换插件实现？
6. 是否在测试 / 预发布环境验证过核心场景和降级路径？

如果以上问题的答案是 “是”，再配合 `plugin-dev-guide.md` 和 `plugin-lifecycle.md` 中的建议，你的插件就比较适合走向生产环境了。 

