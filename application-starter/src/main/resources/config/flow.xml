<?xml version="1.0" encoding="UTF-8"?>
<flow>
    <!--用户注册请求-->
    <chain name="/core/user/register">
        THEN(
            /**校验邮箱是否合法**/
            EmailValidChecker,
            /**校验邮箱是否已经注册**/
            EmailExistsChecker,
            /**校验邮箱验证码**/
            EmailCodeChecker,
            /**创建用户**/
            CPUserBuilder,
            /**保存用户**/
            CPUserSaver,
            /**创建用户token**/
            CPUserTokenCreator,
            /**组建请求返回值**/
            CPUserRegisterResult
        );
    </chain>
    <!--获取用户信息请求-->
    <chain name="/core/user/profile/get">
        THEN(
            /**判断是否登录**/
            UserLoginChecker,
            /**通过id获取用户信息**/
            CPUserSelector.bind("key","id"),
            /**返回用户信息**/
            CPUserGetProfileResult
        );
    </chain>
    <!--修改用户信息-->
    <chain name="/core/user/profile/update">
        THEN(
            /**判断是否登录**/
            UserLoginChecker,
            /**获取当前会话id**/
            CPSessionUserIdGet,
            /**重命名参数**/
            RenameArg.bind("RenameArg","SessionId:UserInfo_Id"),
            /**查询用户信息**/
            CPUserSelector.bind("key","id"),
            /**修改用户信息**/
            CPUserUpdater,
            /**持久化用户信息**/
            CPUserSaver,
            /**构建通知用户**/
            CPUserRelatedCollector,
            /**发送通知**/
            CPNotifier.bind("route","/core/user/profile/get")
        );
    </chain>
    <!--修改用户邮箱-->
    <chain name="/core/user/profile/update/email">
        THEN(
            /**判断用户是否登录**/
            UserLoginChecker,
            /**判断邮箱是否格式正确**/
            EmailValidChecker,
            /**判断验证码是否正确**/
            EmailCodeChecker,
            /**获取用户**/
            CPUserSelector.bind("key","email"),
            /**更新用户数据**/
            CPUserUpdater,
            /**持久化用户信息**/
            CPUserSaver
        )
    </chain>
    <!--用户登录-->
    <chain name="/core/user/login/email">
        THEN(
            /**邮箱校验**/
            EmailValidChecker,
            /**邮箱验证码校验**/
            EmailCodeChecker,
            /**用户查询**/
            CPUserSelector.bind("key","email"),
            /**用户token创建**/
            CPUserTokenCreator,
            /**返回用户token**/
            CPUserEmailLoginResult
        )
    </chain>
    <!--用户token登录-->
    <chain name="/core/user/login/token">
        THEN(
            /**获取token**/
            CPUserTokenSelector.bind("key","token"),
            /**用户token校验**/
            CPUserTokenUidGet,
            /**用户获取**/
            CPUserSelector.bind("key","id"),
            /**用户token更新**/
            CPUserTokenRefresh,
            /**数据持久化**/
            CPUserTokenSaver,
            /**将用户注册进上下文**/
            CPSessionRegister,
            /**返回token数据**/
            CPUserTokenLoginResult
        )
    </chain>
    <!--用户登出（删除token）-->
    <chain name="/core/user/login/token/logout">
        THEN(
            /**判断用户是否登录**/
            UserLoginChecker,
            /**获取token**/
            CPUserTokenSelector.bind("key","token"),
            /**用户token删除**/
            CPUserTokenDeleter
        )
    </chain>
    <!--创建频道请求-->
    <chain name="/core/channel/create">
        THEN(
            /**判断用户是否登录**/
            UserLoginChecker,
            /**获取用户id**/
            CPSessionUserIdGet,
            /**重命名参数**/
            RenameArg.bind("RenameArg","SessionId:UserInfo_Id"),
            /**查询用户**/
            CPUserSelector.bind("key","id"),
            /**创建频道信息**/
            CPChannelCreator,
            /**创建用户信息**/
            CPChannelMemberCreator,
            /**重设用户权限**/
            CPChannelMemberAuthoritySetter.bind("key","admin"),
            /**保存**/
            CPChannelSaver,CPChannelMemberSaver,
            /**返回创建结果**/
            CPChannelCreateResult
        )
    </chain>
</flow>